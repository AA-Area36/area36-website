# Plan: Fix Recordings Page Security, Playback, and Downloads

## Summary
Fix three issues with the recordings page:
1. **Security**: Recordings for locked folders are being sent to the client before password entry
2. **Player Not Working**: Audio doesn't play due to CORS issues with direct Google Drive URLs
3. **No Downloads**: Download functionality is missing

## Changes Overview

### 1. Security Fix - Filter Locked Folder Recordings Server-Side

**File**: `app/recordings/page.tsx` (lines 70-76)

**Problem**: The server component sends ALL recordings to the client. While the UI shows a lock icon, the actual recording data is exposed in client-side JavaScript.

**Solution**: Filter recordings before passing to `RecordingsClient` - only include recordings from unlocked folders.

```typescript
// Current (INSECURE)
const filteredRecordings: Record<string, typeof recordings[string]> = {}
for (const cat of filteredCategories) {
  if (recordings[cat.id]) {
    filteredRecordings[cat.id] = recordings[cat.id]
  }
}

// Fixed (SECURE)
const filteredRecordings: Record<string, typeof recordings[string]> = {}
for (const cat of filteredCategories) {
  if (recordings[cat.id]) {
    // Only include recordings if folder is unlocked
    const isUnlocked = !cat.folderId || unlockedFolders.includes(cat.folderId)
    if (isUnlocked) {
      filteredRecordings[cat.id] = recordings[cat.id]
    } else {
      // Locked folders: show category tab but no recordings data
      filteredRecordings[cat.id] = []
    }
  }
}
```

---

### 2. Create Audio Streaming API Route (Proxy)

**New File**: `app/api/recordings/stream/[fileId]/route.ts`

**Purpose**: Proxy audio from Google Drive to avoid CORS issues.

**Implementation**:
- Validate user has access to the file's folder via session cookie
- Fetch audio from Google Drive using service account credentials
- Stream the audio with proper headers
- Support range requests for seeking

```typescript
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ fileId: string }> }
) {
  const { fileId } = await params
  
  // Get Google Drive credentials
  const env = await getEnv()
  const credentials = getGDriveCredentials(env)
  
  // Validate access - check if file's parent folder is unlocked
  const { valid } = await validateRecordingAccess(fileId, credentials)
  if (!valid) {
    return NextResponse.json({ error: "Access denied" }, { status: 403 })
  }
  
  // Get access token and fetch from Drive
  const accessToken = await getAccessToken(credentials)
  const driveUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`
  
  // Forward range header for seeking
  const rangeHeader = request.headers.get("range")
  const headers: HeadersInit = { Authorization: `Bearer ${accessToken}` }
  if (rangeHeader) headers["Range"] = rangeHeader
  
  const driveResponse = await fetch(driveUrl, { headers })
  
  // Return streamed response with proper headers
  return new NextResponse(driveResponse.body, {
    status: driveResponse.status,
    headers: {
      "Content-Type": driveResponse.headers.get("content-type") || "audio/mpeg",
      "Content-Length": driveResponse.headers.get("content-length") || "",
      "Accept-Ranges": "bytes",
      "Cache-Control": "private, max-age=3600",
    }
  })
}
```

---

### 3. Create Download API Route

**New File**: `app/api/recordings/download/[fileId]/route.ts`

**Purpose**: Enable downloading recordings with proper filename.

**Implementation**:
- Same access validation as streaming route
- Add `Content-Disposition: attachment` header with original filename
- Proxy download from Google Drive

---

### 4. Shared Access Validation Utility

**New File**: `lib/recordings/access.ts`

**Purpose**: Shared logic for validating file access (used by both stream and download routes).

```typescript
export async function validateRecordingAccess(
  fileId: string,
  credentials: GDriveCredentials
): Promise<{ valid: boolean; filename?: string }> {
  // Get file metadata to check parent folder
  const file = await getFileMetadata(credentials, fileId)
  
  // Check if parent folder is registered in database
  const db = await getDb()
  const registeredFolders = await db.select().from(recordingFolders)
  const registeredIds = new Set(registeredFolders.map(f => f.driveId))
  
  // Validate parent is registered AND unlocked
  for (const parentId of file.parents || []) {
    if (registeredIds.has(parentId)) {
      const unlocked = await isFolderUnlocked(parentId)
      return { valid: unlocked, filename: file.name }
    }
  }
  
  return { valid: false }
}
```

---

### 5. Client Component Updates

**File**: `app/recordings/recordings-client.tsx`

#### 5a. Update Audio Source URL (line 273)
```typescript
// Current (broken)
<source src={playerState.recording.streamUrl} type="audio/mpeg" />

// Fixed (uses proxy)
<source src={`/api/recordings/stream/${playerState.recording.driveId}`} type="audio/mpeg" />
```

#### 5b. Add Download Import (line 17)
```typescript
import { Play, Pause, Volume2, VolumeX, Search, X, Filter, Calendar, Clock, Mic, Lock, Download } from "lucide-react"
```

#### 5c. Add Download Button to Recording Cards (around line 437-481)
- Change the outer `<button>` to a `<div>` container
- Keep play button inside
- Add a download button/link with `href="/api/recordings/download/${recording.driveId}"`

#### 5d. Add Download Button to Sticky Player (around line 540)
- Add download link next to volume controls

---

## Files Summary

| Action | File Path |
|--------|-----------|
| Modify | `app/recordings/page.tsx` |
| Create | `app/api/recordings/stream/[fileId]/route.ts` |
| Create | `app/api/recordings/download/[fileId]/route.ts` |
| Create | `lib/recordings/access.ts` |
| Modify | `app/recordings/recordings-client.tsx` |

---

## Implementation Order

1. Create `lib/recordings/access.ts` (shared validation utility)
2. Create `app/api/recordings/stream/[fileId]/route.ts` (audio streaming)
3. Create `app/api/recordings/download/[fileId]/route.ts` (downloads)
4. Modify `app/recordings/page.tsx` (security fix)
5. Modify `app/recordings/recordings-client.tsx` (new URLs + download buttons)

---

## Verification

1. **Security Test**:
   - Visit recordings page without entering any passwords
   - Open browser DevTools â†’ Network tab
   - Verify that recording data for locked folders is NOT in the page response
   - Categories should still show with lock icons, but recordings array should be empty

2. **Playback Test**:
   - Unlock a folder with password
   - Click a recording to play
   - Verify audio plays in browser
   - Test seeking (clicking on progress bar)
   - Test play/pause

3. **Download Test**:
   - Click download button on a recording
   - Verify file downloads with correct filename
   - Verify locked folder recordings cannot be downloaded (403 error)

4. **Access Control Test**:
   - Try accessing `/api/recordings/stream/{lockedFileId}` directly
   - Should return 403 Access Denied
   - Unlock folder, try again - should stream audio
