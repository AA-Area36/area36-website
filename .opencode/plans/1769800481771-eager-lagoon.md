# Plan: File Metadata Admin System

## Overview
Create an admin interface for managing file display names and passwords across all Google Drive files on the site. This includes a new database table, an admin page with folder hierarchy explorer, and file-level password protection with session-based access.

---

## Database Schema

### New Table: `file_metadata`

```sql
CREATE TABLE IF NOT EXISTS file_metadata (
  id TEXT PRIMARY KEY,
  drive_id TEXT NOT NULL UNIQUE,        -- Google Drive file ID
  parent_folder_id TEXT NOT NULL,       -- Parent folder ID for querying
  display_name TEXT NOT NULL,           -- Custom display name
  password TEXT,                        -- Optional password (null = no protection)
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_file_metadata_drive_id ON file_metadata(drive_id);
CREATE INDEX IF NOT EXISTS idx_file_metadata_parent_folder ON file_metadata(parent_folder_id);
```

### Schema Definition (`lib/db/schema.ts`)

```typescript
export const fileMetadata = sqliteTable("file_metadata", {
  id: text("id").primaryKey(),
  driveId: text("drive_id").notNull().unique(),
  parentFolderId: text("parent_folder_id").notNull(),
  displayName: text("display_name").notNull(),
  password: text("password"), // null = no protection
  createdAt: text("created_at").notNull().default(sql`(datetime('now'))`),
  updatedAt: text("updated_at").notNull().default(sql`(datetime('now'))`),
})
```

---

## Files to Create

### 1. Database Migration
**File:** `lib/db/migrations/0007_file_metadata.sql`

### 2. Admin Page & Components
**Files:**
- `app/admin/(dashboard)/files/page.tsx` - Main admin page with folder explorer
- `app/admin/(dashboard)/files/actions.ts` - Server actions for CRUD operations
- `app/admin/(dashboard)/files/folder-explorer.tsx` - Client component for folder hierarchy
- `app/admin/(dashboard)/files/file-metadata-dialog.tsx` - Dialog for editing file metadata

### 3. File Access Library
**Files:**
- `lib/files/session.ts` - Cookie management for unlocked files (similar to recordings)
- `lib/files/access.ts` - Access validation for protected files

### 4. API Routes for Protected Downloads
**Files:**
- `app/api/files/download/[fileId]/route.ts` - Protected download endpoint
- `app/api/files/preview/[fileId]/route.ts` - Protected preview endpoint

### 5. Shared Components
**Files:**
- `components/password-dialog.tsx` - Already exists, can be reused

---

## Files to Modify

### 1. Schema & Types
- `lib/db/schema.ts` - Add fileMetadata table
- `lib/gdrive/types.ts` - Add FileWithMetadata interface

### 2. Google Drive Helpers
- `lib/gdrive/resources.ts` - Inject metadata from DB
- `lib/gdrive/committees.ts` - Inject metadata from DB
- `lib/gdrive/recordings.ts` - Optionally integrate (or keep separate)

### 3. Display Components
- `app/resources/resource-viewer.tsx` - Handle protected files
- `components/committees/committee-files.tsx` - Handle protected files

### 4. Admin Navigation
- `app/admin/(dashboard)/layout.tsx` - Add "Files" nav link

---

## Implementation Details

### Admin Folder Explorer

The admin page will show a tree view of all Google Drive folders:

```
Resources/
â”œâ”€â”€ Delegate Reports/
â”‚   â”œâ”€â”€ 2025 Delegate Report.pdf [Edit Metadata]
â”‚   â””â”€â”€ 2024 Delegate Report.pdf [Edit Metadata]
â”œâ”€â”€ Area Documents/
â”œâ”€â”€ Forms/
â””â”€â”€ Conference Materials/
Committees/
â”œâ”€â”€ Accessibilities/
â”œâ”€â”€ Archives/
â”œâ”€â”€ Corrections/
â””â”€â”€ Treatment/
Newsletters/
â”œâ”€â”€ 2026/
â””â”€â”€ 2025/
Recordings/
â””â”€â”€ [existing folders...]
```

**Features:**
- Expandable folder tree
- Search/filter by file name
- Click file to edit metadata (display name, password)
- Visual indicator for files with custom metadata
- Visual indicator for password-protected files

### Server Actions (`app/admin/(dashboard)/files/actions.ts`)

```typescript
// Fetch folder structure from all configured Google Drive folders
export async function getFolderStructure(): Promise<FolderNode[]>

// Get all file metadata from database
export async function getAllFileMetadata(): Promise<FileMetadata[]>

// Get metadata for a specific file
export async function getFileMetadata(driveId: string): Promise<FileMetadata | null>

// Create or update file metadata
export async function upsertFileMetadata(data: {
  driveId: string
  parentFolderId: string
  displayName: string
  password?: string | null
}): Promise<FileMetadata>

// Delete file metadata (reverts to using filename)
export async function deleteFileMetadata(id: string): Promise<void>

// Verify file password
export async function verifyFilePassword(driveId: string, password: string): Promise<boolean>
```

### Session Management (`lib/files/session.ts`)

Similar to recordings but for individual files:

```typescript
const UNLOCKED_FILES_COOKIE = "unlocked-files"

export async function getUnlockedFiles(): Promise<string[]>
export async function setUnlockedFile(fileId: string): Promise<void>
export async function isFileUnlocked(fileId: string): Promise<boolean>
```

### Access Validation (`lib/files/access.ts`)

```typescript
export interface FileAccessResult {
  valid: boolean
  filename?: string
  requiresPassword: boolean
}

export async function validateFileAccess(fileId: string): Promise<FileAccessResult>
```

### Protected Download/Preview Routes

The API routes will:
1. Check if file has password in database
2. If yes, verify file is unlocked (cookie check)
3. If unlocked or no password, proxy the download/preview from Google Drive
4. If not unlocked, return 403

### Metadata Injection in Display

When fetching resources/committee files:

```typescript
// In lib/gdrive/resources.ts or similar
async function enrichWithMetadata(files: DriveFile[]): Promise<Resource[]> {
  const driveIds = files.map(f => f.id)
  const metadata = await getFileMetadataByIds(driveIds)
  const metadataMap = new Map(metadata.map(m => [m.driveId, m]))
  
  return files.map(file => {
    const meta = metadataMap.get(file.id)
    return {
      ...driveFileToResource(file),
      title: meta?.displayName || file.name.replace(/\.[^.]+$/, ""),
      isProtected: !!meta?.password,
    }
  })
}
```

---

## UI Flow

### Admin Flow
1. Admin navigates to `/admin/files`
2. Sees folder tree with all Google Drive folders
3. Expands folders to see files
4. Clicks a file to open metadata dialog
5. Sets display name and optional password
6. Saves - metadata stored in database

### User Flow (Protected File)
1. User sees file in resources/committee page
2. File shows lock icon if password-protected
3. User clicks View/Download
4. Password dialog appears (if not already unlocked)
5. User enters password
6. Server validates, sets cookie
7. File downloads/previews

---

## Verification

1. **Database:** Run migration, verify table created
2. **Admin Page:** 
   - Navigate to `/admin/files`
   - Verify folder tree loads with all folders
   - Edit a file's metadata
   - Verify metadata persists
3. **Protected Files:**
   - Set password on a file
   - Visit public page, verify lock icon
   - Click download, verify password prompt
   - Enter password, verify file downloads
   - Refresh page, verify still unlocked (cookie)
4. **Display Names:**
   - Set custom display name on a file
   - Visit public page, verify custom name shows
   - Delete metadata, verify filename shows again

---

## Migration Notes

- Existing recordings system remains unchanged
- File metadata is additive - files without entries use filename
- No breaking changes to existing functionality

---

# Previous Plan: Update Committee Page with Expanded Content and Files

## Overview
Expand the committees page accordion to include full descriptions, downloadable files/forms, and info cards for specific committees. Files will be fetched dynamically from Google Drive folder `1gtwNjoFO3phENdJ-aCXq0ps7sTDDen0U` with subfolders matching committee names.

## Key Files to Modify/Create

| File | Action |
|------|--------|
| `app/committees/page.tsx` | Modify - expand accordion content, add file sections |
| `lib/gdrive/committees.ts` | Create - fetch committee files from Drive |
| `app/committees/actions.ts` | Create - server actions for committee data |
| `components/committees/committee-files.tsx` | Create - file display component |
| `components/committees/committee-info-card.tsx` | Create - info card component |

## Committee Content Requirements

### 1. Accessibilities Committee
**Updated Description:**
> Greetings, and welcome to the Accessibilities Committee page. Quite often the first question is "What exactly constitutes a remote community?" and "What does the Accessibilities committee actually do?".
>
> The definition of Accessibilities community is where it is difficult to carry the AA message because of language, culture, geography, or life condition. As you can see that applies equally as well to communities in the most rural parts of the Area as it does to communities in the heart of Minneapolis who, for a range of reasons, are not getting AA's message. Thus, the central mission of this committee is to go to any lengths necessary to carry AA's message to all those who need it and is just one more link in the chain or responsibility in our effort to help the alcoholic to who still suffers.
>
> At first glance it may seem that this committee reproduces some of the work of the PI or CPC committees. In reality, while the RC does work closely with these two committees, the RC serves a different need and helps fill the gap in our Area's overall 12-step work by reaching out to various communities that might not fall under the responsibility of the other area committees.

**Files Section:**
- Accessibilities History Report (with view/download buttons)

### 2. Archives Committee
**Updated Description:**
> The Archives Committee gathers current and historical information about A.A., especially in our Area and preserves it in a meaningful order. This committee provides a clearinghouse of information in the Area with respect to Archives, coordinating the exchange of ideas and resources between districts. Provides experience and assistance in developing projects that will further the carrying of our A.A. message with respect to Archives.

**Forms Section:**
- Group History Form
- District History Form
- Longtimer Questionnaire

### 3. Corrections Committee
**Forms Section:**
- Pink Can Plan Literature Order Form
- Forma para ordenar sobre el Plan de la Lata Rosa

**Info Card - Form Submission:**
> Mail forms to Pink Can Plan, PO Box 41633, Plymouth, MN 55441-0633 or email them to pinkcanplan@area36.org.

**Info Card - Database Access (with link button):**
> This database contains information about the correctional facilities in Minnesota. Only those with an Area36.org email account can access this database. The database is also password protected. Contact the Corrections Chair about the password.
- Link: https://drive.google.com/file/d/1c6XjH6ODGmRAbFKEEL0APvMza3P9oZYE/view?usp=sharing

**Files Section:**
- Corrections Temporary Contact Program Handbook
- Corrections Temporary Contact Program â€“ For AA Members on the Outside
- Corrections Temporary Contact Program â€“ For AA Members on the Inside
- Corrections Temporary Contact Program â€“ Quick Reference Guide
- Pink Can Plan Wrapper

### 4. Treatment Committee
**Updated Description:**
> The Treatment Facilities Committee leads and coordinates the work of AA members and groups in carrying the A.A. message to alcoholics in treatment facilities.
>
> **A.A. TEMPORARY CONTACT VOLUNTEERS**
>
> A TEMPORARY CONTACT is a member of Alcoholics Anonymous who works with alcoholics both in and coming out of treatment facilities/programs.
>
> THE PRIMARY PURPOSE IS TO HELP THEM BRIDGE THE GAP TO ALCOHOLICS ANONYMOUS.
>
> It is a short term arrangement (30 â€“ 90 days) until the new member has become established in a group and has found permanent sponsorship.
>
> The TEMPORARY CONTACT may do such things as visit the alcoholic before they leave the facility, provide them with AA conference approved literature and a local meeting list, let them know about the AA Grapevine magazine, how to subscribe and possibly give them a couple of old Grapevine issues, visit with them for one on one sharing, take them to a variety of meetings before and after they leave (especially their first day back in the community), meet them at meetings, introduce them to as many AA's as possible, help them into the after meeting coffee groups, call them, ensure they have the phone numbers of several AA's, talk with them about sponsorship and guide them to selecting a more permanent sponsor and a home group.
>
> The TEMPORARY CONTACT must ensure that their information on the contact list is current and accurate.
>
> TEMPORARY CONTACTS will be called upon to help a prospect/patient by matching their ZIP codes, gender and age group whenever possible.
>
> The volunteer lists may be made available to Intergroups, District and Area committees.
>
> A call may come from any of these sources in addition to directly from a prospective member.

**Link:** "Fill out my online form" â†’ Link to `/treatment-temporary-contact-program`

## Implementation Steps

### Step 1: Create Committee Files Fetching (`lib/gdrive/committees.ts`)
- Add function to fetch files from committee subfolders
- Use existing `listFiles` and `listFolders` from `lib/gdrive/client.ts`
- Map folder names to committee slugs (case-insensitive matching)

### Step 2: Create Server Action (`app/committees/actions.ts`)
- `getCommitteeFiles(committeeSlug: string)` - returns files for a specific committee
- Handle empty folders gracefully (return empty array, no UI shown)

### Step 3: Create Committee Files Component (`components/committees/committee-files.tsx`)
- Client component using existing `ResourceItemWithViewer` pattern
- Supports view/download buttons
- Includes PDF viewer modal integration

### Step 4: Create Info Card Component (`components/committees/committee-info-card.tsx`)
- Styled card with title, content, optional email/address
- Support for external link button with lock icon for protected links

### Step 5: Update Committees Page (`app/committees/page.tsx`)
- Convert to hybrid: server component fetches data, passes to client accordion
- Update committee data structure with expanded descriptions
- Add committee-specific content sections (files, forms, info cards)
- Keep existing officer cards and structure intact

## Data Structure

```typescript
interface CommitteeData {
  name: string
  chairName: string | null
  email: string
  description: string | React.ReactNode  // Allow JSX for formatted content
  slug: string  // For matching GDrive folder names
  archivistName?: string
  archivistEmail?: string
  webmasterName?: string
  webmasterEmail?: string
  additionalContacts?: { role: string; name: string; email: string }[]
  // New fields:
  filesLabel?: string  // "Resources", "Files", etc.
  formsLabel?: string  // "Forms"
  infoCards?: InfoCard[]
  relatedPageUrl?: string  // Link to dedicated page
  relatedPageText?: string  // Link text
}

interface InfoCard {
  title: string
  content: string
  email?: string
  address?: string
  link?: { url: string; label: string; isProtected?: boolean }
}
```

## Google Drive Integration

- **Main Folder ID:** `1gtwNjoFO3phENdJ-aCXq0ps7sTDDen0U`
- **Environment Variable:** Add `GDRIVE_COMMITTEES_FOLDER_ID`
- **Subfolder Structure:** Each subfolder name should match committee name (e.g., "Accessibilities", "Archives", "Corrections", "Treatment")
- **File Display:** If no subfolder exists or folder is empty, no files section shown

## UI Layout for Expanded Accordion

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ Committee Name                          Chair: Name       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  [Full description text...]                                 â”‚
â”‚                                                             â”‚
â”‚  Contact: committee@area36.org                              â”‚
â”‚  [Additional contacts if any]                               â”‚
â”‚                                                             â”‚
â”‚  â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  ğŸ“„ Form Name                            [View] [Download]  â”‚
â”‚  ğŸ“„ Form Name 2                          [View] [Download]  â”‚
â”‚                                                             â”‚
â”‚  â”€â”€ Resources â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  ğŸ“„ File Name                            [View] [Download]  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Info Card Title                                      â”‚   â”‚
â”‚  â”‚ Content text...                                      â”‚   â”‚
â”‚  â”‚ Email: email@example.com                             â”‚   â”‚
â”‚  â”‚ [Link Button ğŸ”’]                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â†’ Link to related page                                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Verification

1. **Build check:** `npm run build` passes without errors
2. **Visual check:** Navigate to `/committees` and verify:
   - All 4 updated committees show expanded content
   - Files appear with view/download buttons
   - Info cards display correctly with links
   - Treatment committee links to TCP page
   - Corrections database link shows lock icon
3. **File functionality:** 
   - View button opens PDF viewer
   - Download button downloads file
4. **Empty state:** Committees without files in GDrive don't show files section
